# Third-party payment processing

When you use Stripe Billing with third-party payment processors, Stripe consolidates all of your key billing data, such as subscriptions, invoices, payment amounts, and payment frequencies.

[subscriptions](/billing/subscriptions/creating)

[invoices](/api/invoices)

[privacy policy](https://stripe.com/privacy)

## Mark as paid out-of-band integration

In this type of integration, your system submits payments based on Stripe Invoices to the third-party processor. When the payment completes on the other processor, your system records the Stripe invoice as paid out-of-band. The rest of Billing’s subscription cycle continues normally. You’ll customize two key Stripe Billing workflows:

- Collecting customers’ payment method details

- Paying invoices

The following diagrams illustrate the high-level request flows of a multiprocessor integration.

[Configure Stripe](#configure-stripe)

## Configure Stripe

To set up a multiprocessor integration, you have to make some configuration changes to Stripe.

To prevent customers from paying directly on Stripe, disable automatic emails for any customer who processes payments on a third party provider.  Here’s how you can do that:

- Disable Send finalized invoices and credit notes to customers in Stripe’s automatic billing settings. After you change this setting, changes to any subscription with collection_method set to send_invoice won’t trigger customer emails. Only use this if all of your emailed subscription invoices are paid with a third-party payment provider.

[automatic billing settings](https://dashboard.stripe.com/settings/billing/automatic)

[collection_method](/api/subscriptions/object#subscription_object-collection_method)

If you use the customer portal, disable Allow customers to view and update payment methods in Stripe’s customer portal settings. (You also need to disable Customers can switch plans.) You’ll need to build custom flows for allowing users to self-serve updates to their payment method on a third-party processor.

[customer portal](/customer-management#customer-portal-features)

[customer portal settings](https://dashboard.stripe.com/settings/billing/portal)

[Sign up new customers](#sign-up-new-customers)

## Sign up new customers

First create a blank Customer record on Stripe.

[Customer](/api/customers)

Next, create a Subscription and set the collection_method to send_invoice. This setting doesn’t require a Stripe payment method and generates Invoices which must be paid directly instead. Set the days_until_due parameter to the number of days an unpaid invoice remains open before your configured failed payment logic activates. You’re responsible for retrying failed payments on the third-party provider, and you need to set this long enough so that any recovery workflows you implement have time to complete.

[Subscription](/api/subscription)

[Invoices](/api/invoice)

[configured failed payment logic](/billing/subscriptions/overview#failed-payments)

Third-party payments don’t work with Stripe Checkout or Elements. You have to build a checkout flow that uses the third-party to create a valid payment method but with Stripe as the source of truth for billable amounts. To determine the amount to charge in the checkout flow, retrieve the initial invoice generated by the subscription.

[Stripe Checkout](/payments/checkout)

[Elements](/payments/elements)

[retrieve the initial invoice](/api/invoices/retrieve)

Follow the instructions from the third-party payment provider to collect payment method details from customers. Make sure to set up payment methods for use in future or off-session transactions.

The output of this step varies by processor. Some third-party processors provide a payment method token that you use to generate payments on that processor.

Update the Customer record created in the first step of the subscription creation flow. For convenience, store non-sensitive third-party tokens as metadata on the Customer record.

[first step](#create-customer)

[metadata](/api/customers/object#customer_object-metadata)

Remember to turn off the Send finalized invoices and credit notes to customers option before setting the email property on the Customer.

[Collect payment](#collect-payment)

## Collect payment

[webhook](/webhooks)

All invoices (including the first invoice created from a subscription) start in a draft state and trigger invoice.created webhooks. Invoices created by a subscription are automatically finalized after 1 hour to give time for integrations to modify the draft invoice. Finalize the invoice manually to skip this delay.

[invoice.created](/api/events/types#event_types-invoice.created)

[Finalize the invoice manually](/api/invoices/finalize)

Invoice finalization triggers an invoice.finalized event. Listen to this event to trigger payments on the third-party processor.

[invoice.finalized](/api/events/types#event_types-invoice.finalized)

[Listen to this event](/billing/subscriptions/webhooks)

Follow the instructions from the third-party payment provider to collect payments for the amounts represented on each invoice using the tokens stored on the associated Customer record. This might include listening to webhooks from the third party for notifications of successful payments.

When payment on the third party is successful, mark the corresponding invoice as paid_out_of_band.

Mark the invoice as paid before the subscription’s payment due date to keep the subscription operating normally. The Subscription object’s days_until_due attribute defines the payment due date.

[days_until_due](/api/subscriptions/object#subscription_object-days_until_due)

[Handle state changes](#handle-state-changes)

## Handle state changes

To cancel Subscriptions, remove third-party payment method details from Stripe’s Customer records and your database. Listen for the customer.subscription.deleted event and delete any tokens related to the cancelled subscription.

[customer.subscription.deleted](/api/events/types#event_types-customer.subscription.deleted)

Some third-party payment processors allow end customers to cancel billing agreements directly. If the processor allows this, listen for any associated events and then cancel the subscription on Stripe.

[cancel the subscription](/api/subscriptions/cancel)

You’re responsible for processing refunds and disputes originating from the third-party processor. To maintain accurate accounting data, use Credit Notes to adjust the amounts on issued invoices to log refunds. Create a Credit Note, and set the out_of_band_amount to the refunded amount.

[Credit Notes](/api/credit_notes/object)

[out_of_band_amount](/api/credit_notes/create#create_credit_note-out_of_band_amount)

[Other considerations](#other-considerations)

## Other considerations

To switch a customer from a third-party processor to Stripe:

- Collect a new payment method for the customer by setting up future payments or using the Customer Portal.

[setting up future payments](/payments/save-and-reuse?platform=checkout)

[Customer Portal](/no-code/customer-portal)

- Update the subscription collection_method from send_invoice to charge_automatically and set the new payment method as the default_payment_method.

[collection_method](/api/subscriptions/update#update_subscription-collection_method)

- Delete any existing third-party payment method tokens.

You must handle any recovery of failed third-party payments yourself. Stripe doesn’t have any visibility into third-party payment state until you mark an invoice as paid.

Stripe Tax automatically adds the correct tax amounts to invoices as long as you set a billing postal code or IP address when updating the Customer record after checkout.

[updating the Customer record after checkout](#update-customer)

Partial Payments on out_of_band invoices are not directly supported today. In the event of a partial payment, use a Credit Note to adjust the original invoice then manually generate a new invoice for any remaining balance.
